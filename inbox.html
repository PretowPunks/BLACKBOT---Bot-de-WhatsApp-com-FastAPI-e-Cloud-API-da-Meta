<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Inbox (MVP)</title>

<style>
/* (seu CSS completo permanece exatamente igual) */
</style>
</head>

<body>

<header>
  <h1>Inbox — Confeiteira</h1>
  <div id="top-controls">
    <input id="adminToken" type="text" placeholder="X-Admin-Token (opcional)">
    <input id="apiBase" type="text" placeholder="API base (vazio = mesmo host)" />
    <button id="div>
</header>

<main>
  <aside id="list"></aside>

  <section id="chat">
    <div id="chat-header">
      <div style="flex:1">
        <div><span id="h-waid" class="muted">Selecione uma conversa</span></div>
        <div id="h-status" class="muted"></div>
      </div>
      <div>
        <button id="pause">Pausar bot</button>
        <button id="resume">Retomar bot</button>
      </div>
    </div>

    <div id="msgs"></div>

    <div id="toolbar">
      <input id="text" placeholder="Responder como humano..." autocomplete="off"/>
      <button id="send" class="primary">Enviar</button>
    </div>

  </section>
</main>

<div id="statusbar"></div>

<script>
// ============================
// CONFIG
// ============================
let API = "";
let currentWaId = null;

const els = {
  list: document.getElementById('list'),
  msgs: document.getElementById('msgs'),
  text: document.getElementById('text'),
  send: document.getElementById('send'),
  pause: document.getElementById('pause'),
  resume: document.getElementById('resume'),
  h_waid: document.getElementById('h-waid'),
  h_status: document.getElementById('h-status'),
  refresh: document.getElementById('refresh'),
  apiBase: document.getElementById('apiBase'),
  statusbar: document.getElementById('statusbar'),
  adminToken: document.getElementById('adminToken'),
};

els.apiBase.addEventListener('change', () => {
  API = els.apiBase.value.trim();
  toast('Base API atualizada.');
  loadConversations();
});

els.refresh.addEventListener('click', loadConversations);


// ============================
// HELPERS
// ============================
function headers(){
  const h = {"Content-Type": "application/json"};
  const t = els.adminToken.value.trim();
  if(t) h["X-Admin-Token"] = t;
  return h;
}

function toast(msg){
  els.statusbar.textContent = msg;
  els.statusbar.classList.add("show");
  setTimeout(() => els.statusbar.classList.remove("show"), 1600);
}

function fmtDate(s){
  try { return new Date(s).toLocaleString(); }
  catch(e){ return s; }
}


// ============================
// LISTA DE CONVERSAS
// ============================
async function loadConversations(){
  try{
    const url = `${API}/inbox/conversations`;
    const r = await fetch(url, {headers: headers()});
    if(!r.ok) throw new Error(await r.text());

    const data = await r.json();
    els.list.innerHTML = "";

    if(!data.length){
      els.list.innerHTML = '<div class="item"><div class="muted">Sem conversas</div></div>';
      return;
    }

    data.forEach(x =>{
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div class="waid">${x.wa_id}</div>
        <div class="meta">Última: ${fmtDate(x.last_at)} • in:${x.in_msgs} out:${x.out_msgs}</div>
      `;
      div.onclick = () => openChat(x.wa_id);
      els.list.appendChild(div);
    });

  }catch(e){
    console.error(e);
    toast("Erro ao carregar conversas");
  }
}


// ============================
// ABRIR CHAT
// ============================
async function openChat(wa_id){
  currentWaId = wa_id;
  els.h_waid.textContent = wa_id;
  await loadMessages();
}


// ============================
// MENSAGENS DO CHAT
// ============================
async function loadMessages(){
  if(!currentWaId) return;

  try{
    const url = `${API}/inbox/messages/${currentWaId}?limit=200`;
    const r = await fetch(url, {headers: headers()});
    if(!r.ok) throw new Error(await r.text());

    const data = await r.json();

    els.msgs.innerHTML = "";
    data.forEach(m =>{
      const b = document.createElement("div");
      b.className = "bubble " + (m.direction === "in" ? "in" : "out");
      b.textContent = m.body || "";
      els.msgs.appendChild(b);
    });

    els.msgs.scrollTop = els.msgs.scrollHeight;

  }catch(e){
    console.error(e);
    toast("Erro ao carregar mensagens");
  }
}


// ============================
// ENVIAR COMO HUMANO
// ============================
async function send(){
  const text = els.text.value.trim();
  if(!text || !currentWaId) return;

  els.send.disabled = true;

  try{
    const url = `${API}/inbox/send/${currentWaId}`;
    const r = await fetch(url, {
      method: "POST",
      headers: headers(),
      body: JSON.stringify({text})
    });

    if(!r.ok) throw new Error(await r.text());

    els.text.value = "";
    await loadMessages();

  }catch(e){
    console.error(e);
    toast("Falha ao enviar mensagem");
  }finally{
    els.send.disabled = false;
  }
}


// ============================
// PAUSAR / RETOMAR BOT
// ============================
async function pause(){
  if(!currentWaId) return;

  try{
    await fetch(`${API}/inbox/pause/${currentWaId}`, {
      method: "POST",
      headers: headers()
    });
    els.h_status.textContent = "(bot pausado)";
  }catch(e){
    toast("Falha ao pausar");
  }
}

async function resume(){
  if(!currentWaId) return;

  try{
    await fetch(`${API}/inbox/resume/${currentWaId}`, {
      method: "POST",
      headers: headers()
    });
    els.h_status.textContent = "";
  }catch(e){
    toast("Falha ao retomar");
  }
}


// ============================
// EVENTOS
// ============================
els.send.addEventListener("click", send);

els.text.addEventListener("keydown", e=>{
  if(e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    send();
  }
});

els.pause.addEventListener("click", pause);
els.resume.addEventListener("click", resume);

// Inicializa
loadConversations();

</script>
</body>
</html>